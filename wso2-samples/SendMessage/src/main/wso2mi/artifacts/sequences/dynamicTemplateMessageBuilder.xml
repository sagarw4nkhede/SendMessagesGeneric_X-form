<?xml version="1.0" encoding="UTF-8"?>
<sequence name="dynamicTemplateMessageBuilder" xmlns="http://ws.apache.org/ns/synapse">

    <filter xpath="get-property('isButtonsPresent') = 'true'">
        <then>
            <!-- Payload with buttons -->
            <log>
                <property name="then----------" value="-block"></property>
            </log>
            <payloadFactory media-type="json" template-type="default">
                <format>
                    {
                        "messages": [
                            {
                                "from": "$1",
                                "to": "$2",
                                "messageId": "$3",
                                "content": {
                                    "templateName": "$4",
                                    "templateData": {
                                        "body": {
                                            "placeholders": $5
                                        },
                                        "buttons": $6
                                    },
                                    "language": "$7"
                                },
                                "callbackData": "Callback data infobip to kraft",
                                "notifyUrl": "$8"
                            }
                        ]
                    }
                </format>
                <args>
                    <arg expression="get-property('from')" />
                    <arg expression="get-property('to')" />
                    <arg expression="get-property('messageId')" />
                    <arg expression="get-property('templateName')" />
                    <arg expression="get-property('placeholders')" />
                    <arg expression="get-property('buttons')" />
                    <arg expression="get-property('language')" />
                    <arg expression="get-property('notifyUrl')" />
                </args>
            </payloadFactory>
        </then>
        <else>
            <!-- Payload without buttons -->
            <log>
                <property name="else----------" value="-block"></property>
            </log>
            <payloadFactory media-type="json" template-type="default">
                <format>
                    {
                        "messages": [
                            {
                                "from": "$1",
                                "to": "$2",
                                "messageId": "$3",
                                "content": {
                                    "templateName": "$4",
                                    "templateData": {
                                        "body": {
                                            "placeholders": $5
                                        }
                                    },
                                    "language": "$6"
                                },
                                "callbackData": "Callback data infobip to kraft",
                                "notifyUrl": "$7"
                            }
                        ]
                    }
                </format>
                <args>
                    <arg expression="get-property('from')" />
                    <arg expression="get-property('to')" />
                    <arg expression="get-property('messageId')" />
                    <arg expression="get-property('templateName')" />
                    <arg expression="get-property('placeholders')" />
                    <arg expression="get-property('language')" />
                    <arg expression="get-property('notifyUrl')" />
                </args>
            </payloadFactory>
        </else>
    </filter>
    <log level="full">
        <property name="Extracted Data-22-------" expression="get-property('placeholders')" />
        <property name="Extracted buttons--------" expression="get-property('buttons')" />
    </log>
</sequence>
